**9.09-BTC-比特币脚本(Av37065233,P9)**

本节将介绍比特币交易中使用的脚本语言。以下是一个比特币交易的实例，该交易包含一个输入和两个输出。左侧标注为“output”，实际上是该交易的输入，表示该输入使用的币来自于前一个交易的输出。右侧的两个输出中，下方的输出已经被花费，上方的输出尚未花费。该交易已获得23次确认，因此回滚的可能性极小。

### 交易的输入和输出脚本

输入脚本包含两个操作，分别将两个较长的数字压入栈中。比特币使用的脚本语言非常简单，其唯一可访问的内存空间是一个堆栈，与通用编程语言（如C++）不同，比特币脚本没有全局变量、局部变量或动态分配的内存空间。因此，比特币脚本被称为基于栈的语言（stack-based language）。输出脚本有两行，分别对应两个输出，每个输出都有独立的脚本。

#### 交易的宏观信息

交易的宏观信息（meta data）包括以下内容：
- **Transaction ID**：交易的唯一标识符。
- **Hash**：交易的哈希值。
- **Version**：使用的比特币协议版本号。
- **Size**：交易的大小。
- **Lock Time**：交易的生效时间。值为0表示立即生效，非零值表示需要等待一定时间或区块数后生效（例如，等待10个区块后写入区块链）。某些特殊交易会使用该特性。

需要图片：交易的宏观信息结构示意图。

#### 输入和输出部分

交易的输入部分（vin）和输出部分（vout）分别描述了交易的来源和去向。输入部分需要说明花费的币来自哪个交易的输出，并提供签名以证明花费权限。输出部分则描述了转账金额和接收方的相关信息。

需要图片：输入和输出脚本的结构示意图。

### 输入脚本与输出脚本的执行

验证交易合法性时，需要将当前交易的输入脚本与前一个交易的输出脚本拼接在一起执行。早期比特币实现中，这两个脚本是从头到尾执行一遍；但出于安全考虑，现改为分别执行：先执行输入脚本，若无错误，再执行输出脚本。最终栈顶结果为非零值时，交易验证通过；若执行中出现任何错误，交易即为非法。

需要图片：输入脚本与输出脚本拼接执行的流程图。

### 常见脚本形式

1. **Pay to Public Key (P2PK)**  
   输出脚本直接给出收款人的公钥，输入脚本提供签名。验证时，使用公钥检查签名的正确性。

2. **Pay to Public Key Hash (P2PKH)**  
   输出脚本给出公钥的哈希值，输入脚本提供签名和公钥。验证时，需检查公钥的哈希值是否匹配，并验证签名的正确性。这是最常用的脚本形式。

需要图片：P2PK和P2PKH脚本执行流程示意图。

3. **Pay to Script Hash (P2SH)**  
   输出脚本给出赎回脚本（redeem script）的哈希值，输入脚本提供赎回脚本的具体内容及签名。验证分两步：首先验证赎回脚本与哈希值是否匹配；然后执行赎回脚本，验证签名的正确性。

需要图片：P2SH脚本执行流程示意图。

4. **多重签名（Multi-Signature）**  
   通过`OP_CHECKMULTISIG`操作实现，输出脚本提供N个公钥和阈值M，输入脚本提供M个签名。验证时，需检查M个签名是否与N个公钥匹配。

需要图片：多重签名脚本执行流程示意图。

5. **Return脚本**  
   输出脚本以`OP_RETURN`开头，后跟任意内容。该脚本无法通过验证，常用于销毁比特币或在区块链中写入不可篡改的数据。

需要图片：Return脚本的示例。

### 总结

比特币脚本语言是一种简单但功能强大的语言，特别是在密码学相关功能上表现出色。尽管其功能有限，但针对比特币的应用场景进行了优化，确保了安全性和高效性。

需要图片：比特币脚本语言的功能对比图（与以太坊智能合约语言对比）。
