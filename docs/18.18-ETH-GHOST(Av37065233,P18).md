**18.18-ETH-GHOST(Av37065233,P18)**

好，今天我们讲一下以太坊中的共识机制构的协议。以太坊把出款时间降到了十几秒，这对于提高系统的through
put和降低反应时间来说都是很有帮助的。就跟比特币的十分钟的出块时间相比，以太坊的出块速度相当于提高到了40倍。

但是这样大幅度降低出款时间之后，也带来一些新的问题。我们前面讲过，比特币和以太坊都是运行在应用层的共识协议，它底层是一个P2P的overlay
network，这个overlay network
work本身传输的时间是比较长的。因为他的托普协议做弗拉丁的时候没有考虑实际的托谱结构。这就带来一个问题，就是你发布一个区块之后，区块在网络上传到其他节点可能需要十几秒的时间。对于比特币来说，十分钟的出块时间相当于600秒，那么这个是足够让这个新发布的区块传播到网上的其他节点。当然即使这样，因为挖矿是个概率的过程，所以仍然有可能是由两个矿工同时获得记账权，同时发布区块。我们前面讲过，这种情况下会带来临时性的分叉。那么对于以太坊来说，这种临时性的分岔就会变成了常态，而且分叉的数目也会更多。

因为十几秒的出块时间，很有可能别的节点其实还没有来得及收到。你发布的区块还是在沿着原来的区块链往下挖。等到他收到你的区块的时候，可能他自己已经挖出了一个新的区块。

这对于共识协议来说有什么样的挑战呢？比特币的情况是这样的，只有在最长合法链上的那些区块里面所包含的除块奖励才是真正有用的。其他的一些分叉的链上的出块奖励，其实最后是作废了的。我们可以画一个例。

子。

比如说这是个区块链，然后这个地方分岔了。

比如说分了三个叉。这三个差不多是同一个时间取得记账权，最后有一个会胜出，成为最长合法链。比如说中间这个。

像下面这个和上面这个区块，我们管它叫often block，或者叫still block。

有的管叫still block。

就是挖到这个区块的矿工，在这个区块里面有一个铸币交易。比如call in base
transaction能够得到一定数量的比特币。但这个实际上最后是没有用的，因为它不在最长合法链上，所以这里得到的出块奖励最后等于是作废了。

对于比特币来说，因为出现这种临时性分叉的情况不是很多，所以这么规定还是可以接受的。但是对于以太坊来说，如果也这样处理的话，那么意味着什么？意味着这个矿工挖到的区块有很大概率可能是白挖了。大家听明白了吗？你辛辛苦苦挖出一个区块，因为系统中分叉很多，所以很有可能你挖出这个区块，他最后没有成为最强合法恋人，这时候你怎么办？就作废了。那这样对挖到矿的矿工来说不是很公平，尤其是对于个体矿工，这种情况更为严重。

我们前面讲过，现在挖矿呈现出两个趋势，一个是挖矿设备的专业化，现在已经很少有人用我们自己普通的桌面机去挖矿。服务器多少一般都是用专门的设备，像ac芯片或者对于以太坊来说用GPU去把控。第二个趋势是什么？是大型矿石的出现，就是个体矿工算力有限，有很多是组成了大型矿池。就资本的运作有很多算力实际上是集中在大型矿池。这个不光是我们前面看到过比特币是这样，我们下节课还会看到以太坊，其实也是这样的，叫manning
pool。

那么为什么说对个体矿工，尤其是不公平呢？正常情况下，我们希望的情况是你这个矿池能够得到了收益。应该你跟你所占的算力比例是一致的。比如说你这个矿石，你的算力是整个系统总算力的30%。假设你是个大矿石，那么你得到了挖矿的收益也应该是整个系统的30%，这样才算公平。但是如果我们这个共识协议设计不好的话，有可能这个大矿池得到了收益超过他算力的比例。比如说我们。刚出院分岔的时候。

这个时候。

假设上下两个是个体矿工挖出来的区块，中间这个是某一个大矿石挖出来的。那么下面会怎么变化呢？这个大矿池肯定是沿着它自己分叉往下挖，因为它的算力很强，所以他挖出下一个区块的概率是比较大的。而上下这两个分叉，它们是个体矿工的，他主要得寄希望于别的矿工会沿着他们这两个分叉往下挖。因为他自己的算力是微不足道的，他就是个体矿工，光靠他自己沿着这个往下拉是比不过别人的，所以他只能是希望别人能够沿着他这个链望。但对于别的矿工来说，他看到这三个分叉，他其实没有什么理由倾向于沿着这两个个体矿工的分叉去挖。

就换句话说，你个体矿工如果是作为一个整体的话，它的算力是分散的。出现分叉之后，它算力是分散的，这样造成的结果是什么？就是假设这个矿石本身挖到区块的概率是30%，但是他挖到区块之后成为最长合法链的概率是很高的，就很可能变成这个样。这样就会造成。

什么。

叫mancentralization是占便宜的。

这个挖矿的集中化。实际情况可能比这个更糟。一般来说，大型矿池在这个区块链网络中占的位置是比较好的，有的可能是在网络中多个地方都有接口。所以这个大型矿池发布出去的区块有可能会更早的被其他节点所收到。所以这三个区块就算是同时挖出来的。那么中间那个大型矿石发布的区块可能是别的节点，最先收到的就是这个区块。

而且从过去的历史经验来看，这个大型矿石所在的分叉更有可能成为最长合法链。这个其实也就促使别的矿工会沿着这个分岔去继续挖。因为你沿着别的分叉去挖的话，很有可能就白挖了。这样的话就使得大型矿石就个出现一个恶性循环，越是大型矿石得到的收益越大，这个maning
satalization它的情况就更严重。这个有的时候我们管它叫centralization
bias。

就中心化带来的不成比例的优势。大家听明白这个motivation了吗？如果我们就什么都不改，以太坊就沿用比特币的共识机制就会有一定问题。这个其实我们在很多节课以前已经暗示过了，就讲为什么它这个设计是存在问题的，为什么要调整挖矿难度？调整挖矿难度的目的是为了稳定出块时间，不是说越短越好。那怎么办呢？

以采坊中采用了一个基于构思的协议。

的共识机制。这个构host的协议并不是以太坊发明的，就在以太坊出现以前就已经有了构思的协议了。以太坊对这个协议做一些修改，这个协议的核心思想是什么？就是你挖倒了矿，发布一个区块，这个区块最后作废了，你挺伤心的。我们给你一些安慰，给你一些奖励，说这个时候你也能够得到一些出块奖励。就比如说我们说这种区块它没有成为最长合法链，变成了often
block或者still block这个以太坊给他一个好听的名字叫ancle block。

为什么叫ancle？就这个区块。相对于这个最长合法链上的当前区块来说，它是它的舒服区块。就他跟他的父亲是一个辈分的，他他的叔父去块叫ancle
block。然后。他是这样规定的，就这个区块带发布的时候，可以把这个舒服区块包含进来。就是说把这个认为是舒服区块，这样的话这个区块能够得到8分之7的出块奖励。

就以太坊的出块奖励，以前刚开始的时候是五个以太币，就发布一个区块你能够得到5个亿台币。去年下半年的时候改了改成三个亿台币。所以这个初块奖励是多少？是8分之7乘以三个亿台币。

说你挖到矿了，最后没有被认可，也能得到一定的好处。那对这个当前区块来说，它干嘛要包含这个区块呢？就对它是有好处的。大家听明白了吗？对它有啥好处？你如果包含一个舒服区块，可以得到32分之1的额外的出块奖励，就32分之1乘以3。然后你自己本身挖到那个。

三个以太币的奖励还是成立的，所以这就你可以得到这么多出口奖。一个区块最多可以包括两个舒服区块，所以这个例子当中，上下两个。都可以被报进来。他得到的出块奖励，前面这部分还要乘一个二，就因为它包含了两个uncle
block。

大家听明白了吗？

这个协议的核心思想是对于你挖到了矿，但是最后没有得到认可的那些矿工给予一种安慰。虽然你挖的区块没有成为最长合法链上的区块，但是你仍然能够得到大部分的初块奖励，就8分之7的出考奖励，这个比例是很高了。实际上大部分奖励你仍然是拿得到的。

这样设计有利于鼓励系统中出现分叉之后及时进行合并。就相当于是底下这个链上面的这个区块把另外两个分叉链给招安过来了。就给你一点好处，你合并过来给他招安过来了。这是构思协一个最初的版本。那下面我来问一个问题，这个版本的协议有没有什么缺陷？如果就按照我刚才描述的这样设计有没有什么缺陷？

大家听明白这个协议怎么运作的了吗？

他怎么确定我出的这个块是ancle
block？你发布区块的时候，你不知道你是希望你发布的是个最长合法链上的区块。但是你可能你发布出去之后，别人也发布了。那么别人在发布下一个区块的时候，可以把你那个区块包含进来。就我们详细讲一下，就假设这个区块没有了。

假设你发布这个区块，你听到有这个区块，那么这个区块跟你实际上是兄弟关系，对吧？然后你开始挖下一个区块，因为你知道这个区块存在，所以你在挖下一个区块的时候，就可以把这个区块认作你是你的舒服区块。我们是两节课前讲这个block
hea的数据结构，大家还记得吗？里面有一项就是输复区块的哈希值，就有负区块的哈希值，也有输复区块的哈希值。你挖下一个区块的时候，就可以把这个设成你舒复区块。

大家听明白了吗？

过了一阵。

过一会儿你发现还有另外一个输字区块，那你下个区块要改。对，就你挖矿的时候，比如说你挖着挖着还没挖出来，发现这个疏服区块也是存在的。那么你想把它也包含进去，你得改block
header，然后你再继续挖。这个其实是对你挖矿来说没有什么损失。因为挖矿的过程是什么？我们前面说一个词无记意义的是memory叫progress
fra就。你只要你当前还没有挖到区块，你把这个嗨的改完之后重头再挖，跟你一开始就重头再挖是一样的，你并不吃亏倒是。

那您说您刚说的是他那个。

这个是个问题，uncle不只能爆含两个，如果出现第三个。这个哥们儿就不开心了。我们首先设计这个协议的目的是什么？如果你不给这2个1点好处的话，他们可能不愿意合并过来。因为他一旦放弃自己所在的分叉，就什么好处都没有了，对吧？所以你给他家好处把它招安过来，但只能招安两个，又出现第三个怎么办？这是一个问题，还有没有别的问题？

就是我们说这个区块。就这个区块，把它作为舒服的区块的前提是什么？就刚才我们讲的过程是在挖这个区块的时候，已经知道这个区块的存在了，对不对？就是你发布这个区块的时候，然后你听到有这么个区块，你开始挖下一个的时候，你可以把它包含进来。如果是你已经发布了这个区块，然后才知道这个区块这个时候就来不及了。那这个虚化又变成什么好处都没有了，对吧？

还有就是说你知道的时候，如果出现三个舒服区块，你只能包含两个，那么也存在一定的损失。他规定只能包含两个也是有道理的。因为你这个舒服虚块得到8分之7的出块奖励是很高的。你要不限制的话，一任100个叔服，那以太坊中的以太币就太不值钱了，所以他还是要有一定限制。

还有一个什么问题？如果这个矿工比较自私的话，他有可能故意不把这个区块包含进去。这也不叫自私，就是都是矿石。矿石是有竞争关系的，它出于商业利益。我挖这个区块的时候，我知道有这个区块我就不包含你，这样会有什么后果？

这样对这个输付区块来说，8分之7的除块奖励就得不到了。对他自己来说，32分之1的出块奖励是得不到。好像是损人不利己是吧？但是你要从商业竞争的角度上讲，这么做对他的损失是比较小的对这个矿工的损失是比较大的。所以有的矿石可能故意就这么做。

大家听明白了吗？

那怎么办呢？

把这个协议改一改。就这个区块，如果没有包含这个舒服区块，它往下再有一个区块。按道理来说，这个不是舒服区块，对吧？他跟他爷爷是一辈的，但是以太坊规定不能论资排辈，这个还可以当做它的舒服区块。大家听明白了吗？如果再往下挖一个。那这个好像更不对了，它是它的曾祖父那一辈子。但以太坊，不管它还是它的输付区，可。

这么规定有什么好处？能解决我们刚才说的那几个问题吗？其实你觉得可以解决这些问题。

对，比如说如果他有第四个问的话，如果他要把那个包含进去他。如果要是他如果不包含的话，下边另一个挖出来，他可以包含，他就把那钱挣。

就实样你说的是这个，如果某个矿石处于竞争关系，故意不把这个束缚去块包含进去。比如这个不把它包含进去，你不包含没关系，你不包含别人可以包含下一个区块，就不一定是你挖出来的对吧？你不可能这条链上都是你挖出来的，所以下一个区块它可以把它包含进去，对吧？甚至有可能是什么？这个区块不但不会是跟他一家，这个区块有可能跟他是一家。大家想想是不是就挖出这个区块的矿工，看到底下这条链成为最长合法链之后，可能切换到这个地方来挖，然后把他自己给包含进去。大家明白了吗？这就解决那个问题，其他的问题解决了吗？

出现三个数缚区块，这个包含两个的话，这个还是可以包含。

如果他要是有100个15的区块，它那样。

首先你持续产生舒服阶段对你有什么好处？就你问的这个问题是很对的。我们实际上马上就会讲以太坊是怎么规定的。

舒父矿耻。不，你说的这个肯瑟是对的，所以这个规定还是有问题。我们把协议改成这样还有点问题。

其实本质是什么？

本质就是我们为了改进最初版本的构思协议存在的一些问题。所以我们把舒服的定义扩展，不一定是当代舒服，可能是隔着几代的舒服。但问题就在于隔多少代呢？是不是可以隔100代，隔一千代行不行？刚才那个同学问的问题就是我就在很久很久以前，挖矿难度比较低的时候，不断的产生疏复，区块就期待着被包含。大家听明白这个问题了吗？所以以太坊中怎么规定的？这个黑板不够长，我们把它涂重新画一遍。

假设这是最长合法链。这是最近挖出的区块，这是当前区块。如果在这地方有一个分叉。

这个区块是这个区块的真的舒服，就是按倍份算，它确实是他的舒服。以太坊规定，这个时候可以得到8分之7的出牌奖励。如果往前推一带，是这个地方。他比他来说是上一代的舒服，这是当代舒服，这是上一代书缚。他就得到的是8分之6的数块奖励。

再往上推一代呢。这个越来越远了，得到8分之5的出牌奖励。以此类推。这是8分之4的出块奖励。

8分之3。

8分之2。这个地方？

你们觉得是8分之1对吧？以太坊中规定这个就不算了。这个不行。这么画是不是太难看了，给它擦掉吧。

只有这六个舒服区块，再往前就不舒服。大家听明白了吗？舒缚虚化的定义是什么？必须跟当前这个区块，就是这个区块在七代以内有共同的祖先才询。就从这个地方开始算到我们这个地方。

At most. Seven. Chair moderation.

超过期代就不认了。

就这个区块的是负区块，是这个区块，然后这是当前区块，所以你数一下，1234567，正好七待以内。换句话说，合法的叔父只有六个辈份。大家想想为什么要这么设计？

首先如果你不限制舒父的辈份，不限制隔多少代的话，那么这个实现起来对于一个全节点来说，他要维护的状态就太多了。因为他可能要记着隔着一百代以前有哪些舒服区块，你发布的这个区块包含了舒服区块，其他节点同样也是要验证一下的。另外一个问题，设计最多隔着七代，并且在期待以内出块奖励是逐渐递减的。这样有利于鼓励出现分叉之后尽早进行合并。一出现分叉，你马上就合并的时候，这个时候你能得到的初块奖励是最多的是8分之7。你如果隔了好几代之后，初二奖励就越来越少了，你割的袋数太多了，就得不到任何数块奖励了。所以股励出现分叉之后，及早进行合并。有一个问题，我们刚才没有说这是舒服区块的奖励，我们管它叫做。Uncle
reward.

对这个区块来说，它包含一个舒缚区块，可以得到32分之1的奖励。

这个是固定的。

这个他不管你包含的是哪一个辈份的舒服，就这个六个辈份，你包含任何一个辈份的舒服。对这个当前区块来说，得到了出块奖励都是32分之1。

有问题吗？

如果这个地方加一个区号，这个区块算什么？

这个什么也不算，他跟他是兄弟关系，就这个不算疏服去和。

另外我再解释一下，就我们设计这个协议，主要目的是为了解决系统中出现的叫临时性分叉。包括我们说比特币也好，以太坊也好，为什么规定这个最常合法链的原则，为了防止篡改，使得交易不容易被篡改，其实也是为了解决临时性分叉。就最最常合法链提供了一个出现临时性分叉之后进行合并的一种机制，就是最长练会胜出。如果这个分叉是别的原因造成的，比如说是出于对运行的区块链协议有不同意见，那么这种方法是解决不了的。就我们前面讲分叉的时候说过，我们这个讲的例子都叫state
for对。

对于区块链当前的状态产生了意见分歧，临时性的意见分歧，我们想办法把它合并。如果是别的原因，像我们以前讲那个比特币脚本的时候。

Check multi还。记得这个操作是干嘛的吗？

检查多重签名的合法性。我们讲这个操作的实现上有一个bug，他检查的时候会从堆栈里多弹出一个元素。所以实际上如果你正常操作的话，检查是通不过的，你得先往里面压一个多余的没用的元素，就为了应付这个板，为什么不把这个bug改掉？你改完之后版本不一样了，它跟中性化的系统不一样。中心化系统发布一个新版本很容易，你去中心化的系统，你这么一改的话出现硬分叉，就是这两条链。如果不是因为对当前状态有意见分歧，而是说互相认为对方是非法的，认为对方的区块是包含非法交易的，用这种方法是合并不了的。大家听明白了吗？

你把它包含进来可以，但是这个矿工如果认为这条链是非法的，你包含进来它还是不会沿着你继续挖，他还是沿着他那个分叉链是吧？因为他认为你的那个阻链虽然最长，但它是非法的。

再讲一个问题，我们说比特币发布于去实际上得到的是两部分奖励，一部分叫做block
reward。一部分叫做transaction。有的时候把这个叫做静态奖励，static
reward这个叫做动态奖励。因为你要执行这个交易才能得到传达的身份。以菜坊中也是类似的，也有一个静态的block
reward，就是那三个以太币就是block reward动态奖励它这个叫什么？

叫gas费、汽油费。你的区块里包含了智能合约，执行智能合约的时候可以得到汽油费，叫gas费。我们讲的舒服区块得到8分之7的奖励，只限于这个block
reward，就是8分之7乘以三个以太币。底下这个汽油费是得不到的，输付区块是得不到汽油费的。但是这个问题其实也不大，因为我们会看到，我们待会儿会看一些实际的例子。

汽油费所占的比例是很小的，大部分都是静态的初块奖励。这个跟比特币的情况是类似的，比特币也是说transaction费只占很小一部分。我们之前看的那个例子，transaction费大概是占了出块奖励的1%。

有问题吗？

我没有听明白。

是就是后面到后面的这个区。

你说因为比特币它这个出罐奖励是每隔四年减半，所以等到它趋于零的时候，就变成交易费占主流了。

所以你担心的就是以太坊当中如果也变成了block
reward趋于0，那么那个舒服区块ancle
reward是8分之7的乘以一个趋于零的数，也是趋于零的。这个是这样的，以太坊当中没有规定定期要把出块奖励减半，这个没有这个规定，就是比特币规定是为了人为制造稀缺性，以太坊中没有这么规定。以太坊中的五个以太币去年下半年降降为三个以太币，不是为了这种人为制造稀缺性，它实际上是跟我们下节课要讲的下节课或者是下两节课要讲的挖矿难度调整有关的。就去年大概十月份左右出过什么事情呢？挖矿难度的计算公式里，那个难度炸弹被回调了300万个区块，这样导致挖矿难度大幅度下降。他为了维护公平性，也是为了维护总共以台币的供给量，不要出现剧烈变化。所以他就把这个以太币的block
reward从五个降到3个，这是一次性的，并没有说以后会不断的下调。

这你顺便说一下，比特币实际上大家一般把它当做什么？当做数字黄金。它是用来储值的。

以太坊这个以太币有些人把它比喻成石油，它是用来花的，用来消耗，然后可以执行智能合约的。这个比喻不是完全的恰当，因为石油是什么？你花完之后这石油就没了。比如说你开汽车消耗汽油，这汽油消耗掉之后就没了。以太坊当中你执行智能合约是要消耗gas的，但这个gas只是从一个账户转移到另外一个账户。因为你是你你执行智能合约的时候，你发布智能合约要付出gas费，执行智能合约的那个矿工可以得到gas费。所以说这个比喻也不是完全恰当。但就就这两个加密货币的设计理念是不一样的，以太币没有定期减半的这种说法。

还有别的问题吗？

我来问一个问题。把这个舒服区块包含进来的时候。舒服区块，你的交易要不要执行？

我们上节课说过，以太坊是什么？是一个交易驱动的状态机。比特币其实也是一样的。所以你在这条链上每次发布一个新的区块，都会使当前状态转移到下一个状态，对不对？现在你引入了舒服区块，你把舒服区块也包含进来，要不要执行输复区块中的交易？你觉得不应该，为什么？

万一他就是他的下一个区环跟他舒同时包含了同一个交易，不是你交易次的那个限制。如果输入区块里面有跟我相同的交易，那我就不用。但是有一些就是除了。下一个区块是也应该是执行。

刚才那个同学说的其实是对的，你说的这个情况就是那个同学说是不应该执行，原因是什么？这两个区块很可能包含的交易是有冲突的。就这主链上就最常合法链上的是负区块，这是它的输复区块，它们两个交易是有可能有冲突的。你刚才说那种方法，你是说如果他们俩包含同一个交易，只执行一次就行了。如果包含不同交易就合在一起都执行了。问题是不同交易有可能是不能都执行的，就比如就像比特币一样，可能是有有冲突的交易，他这里没有那种就是它跟比特币不太一样，就是说比特币我们说要做double
spending attack的detection。

要检测是不是双花公积，你这个双花公积是通过账户余额，你花两次，我给你结两次，对吧？但是有可能一个交易花了之后，另一个交易就没法花了。所以如果你这么包含的话，你要去执行这个舒服区块链交易，可能有些交易就变成了非法交易。它的输入区块本身不一定是非法的。你执行完你负区块的交易，再去执行负区块，再去执行输服区块的交易，可能就变成非法了。

你可以进来，我后面还有好多。我们戴星，你是不是生病了？你等多久了？行，刚才说哪来着，你刚才说什么来着？

对，确实就是刚才书库里面有一个交易跟他这个。但是我的意思执行就是说我把它初步的交易放到提前，我也会检查一下这个合同。我本身区块这个交易我检查完之后，我再会去检查他输入权。

不是你实际上说是改进一下，就是包含输服区块之后，输服区块交易能执行还是要执行，不能执行就算了。你是这意思吧？

就是检查这个交易的合法。

我得有这一步，其实以采访不是这么做的，就这么做会很乱，就这状态机的这个状态就弄乱了，就不是沿着一条链下来的，就等于是你执行这一条链上的交易，同时还把分叉链上交易也都执行了。这个实际上不是这样的，以太坊中只有在最长合法链上一条线下来输入区块这些交易这个区块是不执行的。而且他根本就不检查这个舒服区块交易的合法性。

不是舒服虚化替代检查过了，就是他收到这样一个他知道这样一个舒服区块的时候，他只检查一个东西是什么。

什么？

你这个区块有没有是啥意思？

就是你不是说在说。

你说我刚才那个区块发布的时候，还不知道有这个舒服区块，我不是说这种情况。收款地址检查收货修块，收款地址不是检查那玩意儿干嘛？

他是要查一个东西，他查的是什么？他查的这是不是一个合法发布的许可。换句话说，这个区块是不是符合挖矿难度，这个是要查的这要不查的话，因为有疏复去化机制，你随便发布一个垃圾东西，就是你可能根本没有获得记账权，就发布一个东西出去，我也不要求在组链上你把我当叔父就行了。这个是要查的，只要那个舒复虚块是符合挖矿难度要求的，这个只差hea就行了。那么我们就认为它是个合法的舒服去。至于这个区块里包含的交易是不是合法的，这个是不检查的，反正也不执行舒服，区块链交易也不会执行。因为执行起来就跟那个同学说的，可能跟我们这个主链上的交易是冲突的。

大家听明白了吧。

就。

但是这个主链上可以再把这个交易放进去。就你的问题是说我有个交易发布了，但是包含我那个交易的区块是一个舒服区块，所以我那个交易本身并没有得到执行。这个矿工不吃亏，他还是得到奖励了，但我那个交易没执行。那主链上的节点收到你这个交易之后还会继续执行，可能你会要再等一个区块，但还是会执行。最终是拉定到所有节点的。

还有问题吗？

他怎么检测他前面的链上有多少舒服区块，他是听到一个就查一下，是每个发布区块你得说明你的负区块是哪个区块，对吧？所以可以检测到你是不是你的负曲块跟我当前区块是不是有共同属性。

没有问题。我再问一个问题，我到这节课举的所有舒服区块例子有一个共同的特点，你们发现没有？都是分叉之后的第一个区块，对不对？

对我就想说这个如果分叉之后，后面还跟着一串那些怎么办？就比如我把这例子改一改，就不是这样。

改成啥样了？这个地方还是连着的，然后后面是这么串起来的。

前面是个最长合法链，下面是一个分叉链。

比如说这个区块算不算是它的舒服区块？

好像应该算是吧，按倍份是算。那为什么我们不能设立成一个协议，把这个整条链当做舒服去划，给他们每个区块一点奖励，鼓励他合并上去。

但是合并之后才有奖励。就这么规定会有什么问题？你们几个的直觉都是对的，觉得这样有些奇怪的地方，不对劲的地方。如果你这么规定会有什么问题？

就相当于以前我们是招安的时候是单个招安。现在你已经拉出一个队伍来，把你整个队伍招扬过来，大家还是一家。免得出现两个分叉的点。

给那个头。对，后边这个不能分，但是把头的这个浅，它后面分的多。

你说你把这个协议改了，这个奖励还是只给这个投，但是给这个投的奖励要跟后面人平分。

我觉得就只是给那个头，后边那个都不能算。你如果要是后边那个相当于他那个就他就可以不在那儿病了，他就可以往后再挖几个，然后再去回来。

你说的基本是对的，实际上如果这么改的话，会找成个什么问题？

分叉攻击就变得太便宜了，大家还记得分叉攻击是怎么搞的吗？

比如说在这个地方有一个大额的交易，A转给B一大笔以太币。那么B看到这个交易之后等了一些确认，等了这么多的确认区块，他认为肯定没问题，对吧？后面都跟着这么一长串了，然后，A发动分叉攻击。把它转给他自己。

如果要分叉攻击成功，需要下面这条链比上面条链还要长，对不对？这个代价是比较大的，因为风险很高。如果这条链不能变得比上面的长，那这一长串的区块都白挖了，这就是分叉攻击的代价。但是如果你把go思协议改了，把这些都认作是舒服区块，每个给一点奖励，让它整体合并上来的话，那样分叉攻击的风险就大幅度下降了。反正我就先分叉攻击，你攻击成了我就把你的交易回滚了。攻击不成，你反正把我招安过去，我也能得到一些出块奖励。大家听明白了吗？

所以以采访中规定，只有分叉后的第一个区块可以得到ancle
reward，后面的都不行。这个其实跟刚才你说的这个想法是差不多的，就鼓力出现分叉之后及时进行合并。如果你再沿着那个分叉往后面挖的话，就白挖了。

有问题吗？

没有问题，我们下面看一下以太坊中的一些真实的情况。

大家知道ecan dot
io这个网站吗？可以实时查看以太坊的当前状态。右边这个曲线显示的是过去两个星期的交易历史，这个截图的时间比较早，这是五月底截的图。左下方显示的是最新被挖出的区块，右下方显示的是最新的交易。

这个显示的是输复区块的几种情况，这里的每一行对应一个数服区块。第一列的block
he就是区块的序号，也就是block
number，像第一行就是图中第一个红框，这个舒服区块的序号比这个区块本身要小两个，这个说明是一个距离为二的输缚区块。应该得到8分之6的奖励。那么8分之6乘以三个以太币的话，就是2.25个以太币。

接下来的两行都属于这种情况的束缚，再往下一行就是到第二个红框这一行舒复区块的区号只比它小一个，说明是当代舒服。那么应该得到8分之7的奖励，8分之7乘以3就是2.625个以太币。然后接下来这几行都是属于要么是当代束缚，要么是在上一代的束缚。说明实际系统中大多数分叉都很快得到了合并。最下面这一行舒服区块的序号比这个区块小三个，那么应该得到8分之5的奖励，8分之5乘以三是1.875个乙太币。

下面这个表格给出了不同辈份的数，得到的uncle
reward的数目。我们看两个区块的具体例子。左边这个区块包含了一个舒复区块，大家能看出它包含的是哪一代的舒服吗？应该是距离为二的束缚。我们可以看到倒数第二行这个uncle
reward是2.25这个区块得到的奖励，就它本身得到的reward。

倒数第三行这个部分是有三块内容，第一部分是固定的三个以太币的初块奖励。第二部分是汽油费，就是这个0.16685后面一长串这个就是汽油费。第三部分就是包含这个舒服区块而得到的奖励，就是这个32分之1的出划奖励是0.09375个一台币。

然后我们看一下右边，右边这个区块包含了两个输缚区块。一个是距离为一的当代输服，另外一个是距离为二的上一代的舒缚。所以它这里倒数第二行的ancle
reward
2.25加上2.625就等于这里的四点8711111台币。这两个an口的reward合在一起是4.875个一台币。然后这个区块得到了reward，就倒数第三行也是三部分内容。其中第三部分0.1875比左边那个区块恰好是多了一倍。因为它引入的是两个暗口，所以要乘一个二。这两个区块在前面一页的ppt上都是有的。

大家可以通过第一行这个head就区块的he来查一下。比如说左边这个区块的head是5695161，这个就是第一个红框对应的这一行。然后右边那个区块是第二个红框，下面的这两行就是block
head是5695150的这两行，每个输服区块单独占一行。大家看看有什么问题吗？没有问题的话，我们这节课就讲到这里。
