**15.15-ETH-账户(Av37065233,P15)**

首先我们讲一下以太坊系中采用的账户模式。比特币中用的是基于交易的账本transaction
base的measure。这种模式下系统中并没有显示的记录每个账户上有多少钱。我们前面讲过，你要知道有多少钱。根据ut
XO里的信息推算，包括你想知道这个人一共总资产有多少个比特币，那就算一下这个人的所有账户，就是他有私钥的那些账户，在ut
XO里面一共有多少个B就可以了。

这种模式的好处是隐私保护比较好。你有多少钱可能连你自己都说不清楚，那别人就更搞不明白了。但是这样带来的一个问题就它使用上是比较别扭的，跟我们的日常体验不太一样。向转账的时候A要转给B10个比特币。

A要说明这十个币的来源，其中七个B是前面这个交易中收到的，另外三个毕业是之前另外一个教育中收到的。就证明这个交易的币的来源的合法性，就跟我们平时去银行的体验是不太一样的。银行是怎么办？是你存钱的时候需要说明这个钱的来源，这确实是有人转给你钱了，将来你花钱的时候是不用再说明每一笔钱当初是从哪来的。

比特币这个模式，另外一个让人觉得比较别扭的地方就是你在前面的交易中收到一笔输出，收到一些币。你将来要花的时候，必须要一次性都花出去，你不能只花一部分，就比如说A转给了B10个比特币。将来B要转给C三个比特币。

这个B的来源是前面这个。交易如果你就这么写的话，会有什么情况？剩下的七个月。剩下的七个比特币当做喘来山费花出去了，这个矿工是很高兴，你不会高兴。所以必须得把。剩下的七个比特币再转回给自己，比如转到这个币的另外一个地址。很多这个比特币钱包可以自动生成这种接收余额的地址。每次交易换一个新地址，这个也是有利于隐私保护的，就打一枪换一个地方。但同样跟我们的日常生活习惯不太一样，就比如说你银行当中别人转给你10万块钱，你要把3万块钱转出去，剩下7万块钱就不用管，就放到账户上不就行了吗？

问题在什么地方？问题在于比特币系统中没有显示的维护这种基于账户的交易的概念，它是每个交易单独进行处理的。以太坊系统采用的是另一种方法，是基于账户的模型。

这种模型跟我们日常的银行账户是比较相似，就是系统中要显示的记录每个账户上有多少个以太币。就比如说我们前面这个转账的例子。

我们先不看后面，比如说A转给B不是十个比特币了，是十个以太币。

这接改过来了。

这个转账交易是不是合法，只要检查一下A账户上是不是有足够多的钱就行了。就比如说A这个账户上有100个以台币们要转十个给B这就没问题，这就可以。转账的时候不用说明这100个以太币中是具体把哪十个转给了币，就不用说明这些币的来源是来自之前哪个交易的。将来B要转给C要转给C三个以太，B也完全可以不用把剩下的转给他自己。因为你有显示的这种余额的概念。所以剩下的币就直接放到账户上就行了。这个链接也不需要用了，我们讲这个哈希指针也不用说明币的来源。

大家是不是觉得自然多了？这样做有一个好处是什么？

我们前面讲比特币面临的一个主要的挑战就是double spending了它。

花出去的钱又花了一次。以太坊这种基于账户的模式，对于double spending
attack有天然的防御作用，为什么呢？

因为我反正不用管你币的来源，你每花一次钱我就从你的账户余额上扣掉。你要double波spending，你要花两次我就扣两次就行了，不就完了吗？所以他就对这个有很好的防御作用。那这样看来是不是以太坊这种counbase的模式太好了？我们说的都是优点，他是有没有什么弱点？

什么叫凭空账户产生余额，我可能把我账户里的钱。

因为比特币我可以查询你这笔交易的输出来源，最终能查到查到来源。大家听明白他这个同学的问题了吗？就是这个同学说这个模型的缺点在于，如果有人篡改自己账户余额怎么办？就比特币因为是每笔交易都要说明是前面的哪个地方来的，所以你不能凭空造出一个壁来。而以太坊当中，因为你不需要说明币的来源，假设我发布交易的时候，我就篡改一个余额，你是这个意思吗？

这个其实以太坊中也是防范的，就是你发布交易的时候不需要说明你的余额，你的余额是哪来的呢？是系统中全节点维护的状态中要保存的。我们下节课会讲以太坊中的一个重要的数据结构叫状态数。状态数就是所有的账户的状态组成一棵树，这个账户状态里包含的一个重要的域就是balance，就是你的这个余额的话没有办法篡改。如果你要改你的余额，得是所有的全节点都认为你这个余额是发生了变化，否则的话其他节点是不认的，你自己没有办法随便改。还有别的问题吗？

我们说他对double spending
attack有天然的防御作用，但是与之相硬的有另外一个attack。

叫replay attack
g。重放攻给什么意思呢？A转给了B10个以太币，A发布一个交易，就转账交易发布到网络上。然后过一段时间之后，这个交易对写到区块链里面了，所以A就以为这个转账交易是完成了，对吧？假设B是有恶意的，他把这个交易又在网上重新广播了一遍。那其他节点一看，A管B又转账了一次，以为是一个新的转正，就把A的钱扣了两次。大家听明白了吗？这叫重放攻击。

这个重放攻击其实你想一想跟这个W banding是对称的。Double
spending是说花钱的这个人不诚实，以前花过的钱现在要再花一遍。The double
spending这个replay
attack。是收钱的人不诚实，别人已经给你转过钱了，你想让他再转一遍，you
don\'t replay. 那为什么我们以前没有说过replay它？

比特币当中有没有可能出现重放攻击？不可能的，为什么呢？因为是太显然的double
spending。如果别人给你转账，你过一会儿把这个交易重放一遍，那很明显是达波斯班就不会成功了。那以采访中怎么办呢？其实办法很简单。

你们觉得应该怎么办？

加一个计数器，交易次数就记录一下这个账户有史以来一共发布过多少个交易。然后转账的时候，这个交易次数要成为这个交易内容的一部分一起包含进去。都是受到这个交易者发布交易者的签名的保护的。就比如说A这个账户转给B10个以太币，A这个账户一共发布过多少个交易呢？发布过20个交易，这是第21个，所以就写上这个等于21。然后这整个的内容。Sine
by a.

这是一个教育。然后把这个交易发布到网上去，因为它有签名的保护，所以这个l的值别人是改不了的。然后系统中的每个节点维护A这个账户的状态，不光是要维护A的balance，就他这个账上的钱有多少，还要维护这个n的值。这个n的值一开始的时候都是零，就这个账户新创立的时候没有过去的交易，所以nice是等于0的。每次收到这个账户发起的一个交易，nice的值要加1。比如说一开始的时候。

这个节点说A这个账户当前的n是20，然后现在发布这么一个交易。这节点一看，这第21个交易来了，这是合法的，所以这个交易是可以执行的，同时要更新一下。这个MaaS变成21了。以后如果有人重放这个教易。这个节点一看，这当前的n已经是21了，说明第21个交易已经被执行过了，就不会再执行疫遍了。大家听明白了吗？

以太坊当中呢有两类账户，一类呢叫做外部账户。

这个外部账户就类似于我们前面比特币中说的那种账户，就是用公私药控制的。你本地产生一个公钥和私钥的对，谁有这个私钥就掌握了这个账户的控制权，这有时候也管它叫普通账户。那么一个外部账户的状态，有账户余额。还有就是刚才说那个man。这个nice这个名称，这个名字起的不是很好。我们以前遇到过这个n对，挖矿的时候，这个block
header里面有一个也是n那是个随机数。你不停的调这个随机数，它这里实际上是个计数器，对吧？其实应该管它叫counter或者你管它叫sequence
number，就跟tcp协里面有t sequence
number一样，他管它叫。第二类账户是什么呢？是合约账户。

合约账户就不一样了，合约账户不是通过公司要对来控制的，不是说你掌握某个私钥就有对这个合约账户的控制权。合约账户除了这个balance之外，balance和l就大家注意，合约账户也是有这个m的，一个合约可以调用另外一个合约，所以他同样要通过这个n值记录一下这个调用的次数。但是合约账户不能主动发起一个交易，这是以太访中的一个规定，所有的交易只能由外部账户发起一个交易。如果调用了一个合约账户，这个合约账户可以发送一个message，调用另外一个合约，这是可以的。但是他不能够自己平白的就发起一个交易。除此之外，合约账户还有代码扣子以及相关的状态storage存储。包括每个变量的取值。

这些都属于合约账户的一部分。那么合约账户怎么被调用呢？你创建合约的时候，会返回给你一个地址，知道这个合约的地址就可以调用。这个合约调用的过程当中，这个状态会发生变化，这个代码是不变的，这个存储就会变。大家对于这个以太坊的账户模型有什么问题吗？

有一个问题就是为什么要设计这样一种新的模型？就以太坊的创始人叫italiic。

这一个19岁的小孩儿比你们都小，现在长大了一点。就他当初创建以太坊的时候，比特币已经有比较成熟的代码可以作为参考了。那为什么就不用比特币？已有的代码为什么要另搞一套？你系统设计上可以改进了，你要改出块时间，你改manpadle，不一定非要改账户系统。

比特币这个基于交易的账户模型的一个好处是什么？隐私保护比较好一点。你每次交易可以换一个新的账户，打一枪换一个地方。但是以太坊要支持的什么？

要支持的是智能合约，对于合约来说，要求参与者有比较稳定的身份，这个跟我们日常生活当中是类似的。比如说你跟某个人签个合同。如果说你跟他签合同的时候，他是一个身份，签完合同之后，他身份就变了，你找不到了，那这就有问题了。也有可能突然冒出来另外一个人说，他就是当初跟你签合同的，只不过换了一个身份，这就给合同的执行带来了一些困难。包括将来出现纠纷的时候，你也是需要知道这个合同当初是跟谁签的。现在有人提出来了，用智能合约实现一些金融衍生品，叫所谓的叫financial
derivative。

就比如说像那种期权期货这种东西，你往这个合约里投一笔钱，预测未来的价格走势。如果你预测正确的话，给你一些收益，把钱还给你。但问题是，如果你投钱的这个账户投完钱之后就变了，那到时候怎么把钱还给你呢？这个不光是对于我们说的外部账户有这问题，合约账户这个问题就更严重了。如果你投钱投给一个合约账户，投完之后，合约账户的地址变了，你找不到。

那就麻烦了。

所以就以太坊。创建这个系统的时候，考虑了过去的一些已有的模型的利弊得失。最后决定没有采用比特币中已有的基于交易的账户模型，而是采用了基于account的le这种模式。这个从目前的情况来看，还是比较合适的一个决策。就是以太坊中的账户是希望保持稳定的，无论是你的个人账户还是合约账户。当然了，如果是你有隐私保护的需要，你同样是可以创建很多个账户，根据情况使用不同的账户进行不同的交易。大家有问题吗？好，下节课我们会讲一下以太坊中的数据结构。
