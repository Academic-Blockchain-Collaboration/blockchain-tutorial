**23.23-ETH-TheDAO(Av37065233,P23)**

上节课我们讲了宠物攻击的原理，那么这样的攻击在现实中真的会发生吗？这节课我们就讲一下两年前的一个真实的案例，这个案例在以太坊的历史上赫赫有名，造成了以太坊的分裂。可以说整个以太坊的历史都被他改写了。我们说比特币实现了去中心化的货币，以太坊实现了去中心化的合约。既然去中心化这么好，为什么不把所有的都改成去中心化呢？所以就有人提出一个口号叫做nice
decentralized everything。道这个概念就是在这样一个背景下产生的。

去中英化的自治组织。就是传统社会当中，组织是建立在某种法律文件基础上的。比如说可以有一个书面的章程规范这个组织的行为，有时候可能还需要到政府进行登记注错。那么在区块链上到这个组织，就是建立在代码基础上的组织的规章制度是写在代码里的。通过区块链的共识协议来维护这种规章制度的正常执行，这就是道这个概念。在2016年5月的时候，出现了一个致力于众筹投资的道，他的名字叫做的到。

这个名字起的有点儿容易引起歧义，就是道是一个通用的概念，凡是去中心化的自治组织都可以称为道。The道是指具体这个道叫the道，它这个名字起的比较奇怪。他的这个工作原理有点像一个众筹的投资基金，就用来投资项目的。只不过投资的这个钱的来源是通过在区块链上大家众筹的方法得到的。它本质是一个运行在以太坊上的智能合约，然后投哪个项目呢？如果你想参与这个the到，那么你可以把以太币发给这个智能合约，然后可以换回the到的代币。那么需要决定投资哪个项目的时候，是大家投票决定的。你手里的这种代币越多，投票的权重就越大。最后如果有了收益，就投资之后有了收益，么也是按照这个智能合约中制定的规章制度来进行收益分配的。这就是the道德这样一个工作的原理。

所以这个工作方法，实际上有点像是duck的形式，这不是有个道吗？还有一个是duck。Dec前面都跟它是一样的。最后是叫corporation。

去中心化的自治公司，就这两个的区别就大K和道。一般来说duc是出于盈利目的的是为了经营赚钱的，到的话可以是出于非盈利性目的，比如说就是为了某种公益事业。虽然这个大K从名字上来说，它是叫一个公司，叫一个corporation。但是在现实社会当中，他并不具有公司应有的法人地位。一般来说也没有那种像董事长CO这样的职务。

我们回过头来说这个the道，the道2016年5月份开始众筹的时候，在当时受到了很大的关注度。因为以前从来没有这样民主的投资基金。大家都听说过一些风投，一般的风投就是几个vc
partner说了算，他这个是全体大家民主投票的方式来决定。所以在当时被称为是一种伟大的尝试，引起了当时这个互联网这个社区里很大的兴奋。

他从2016年5月份开始众筹，一个月的时间就筹集到了价值1.5亿美元的以太币。当时的以太币价格还是比较便宜的，这些以太币如果放到现在的话，大概是价值几十亿美元。所以那个时候，就在互联网社区上，有很多人发表各种各样的文章就讨论这个事情。因为他这个众筹的速度和规模在历史上是非常罕见的，比很多众筹网站要快得多。这也反映出了区块链技术的一个强大生命力。所以当时有互联网上有各种各样的评论，大家预测若干年以后的到的影响力会有多么的大。有的人甚至说3到5年以后，the
dog的影响力会超过以太坊本身。遗憾的是，the稻没有能等到3到5年，一共只存活了三个月。

问题出在哪里？比如说你是一个的道的投资者，你怎么取回你的收益？就比如说你参与的到，你投了一笔以太币过去换回一些得到的代币，你用这些代币可以投票决定投哪个项目之类的。过一段时间之后，你需要用钱了，先把以前投资的那些以太币换回来怎么办？这个在the到这个基金里是通过拆分的方法来实现的，就叫做split刀。

拆分到这个拆分的方法，不是单纯用来取回你的收益，也是一种建立子基因的方法，叫是child。

就拆分完之后得到一个拆到。这个设计的理念是这样的，就我们说这个到投资项目是靠大家一起用手中的这种代币去投票。如果有一小部分人他的投资理念跟其他人不一样怎么办？比如说有某一个小众化的项目，可能少数一些人认为很好，是值得投的，但是得不到大多数人的认可。这种情况下，这一小部分人可以用拆分的方法从the道里面独立出来，成立一个自己的子基金，就是叫child的道。然后这拆分的时候，他们手中的这些代币是要被收回去的。换成相应数量的以太币，就把相应数量的以太币打到他们这个子基金里，然后他们就可以投他们想投的项目了。大家听明白了吗？

这个拆分的过程，拆分的一个极端的例子就是单个投资者成立一个子基金，就这个child的道里面就他一个人。然后到这个子基金理他就可以把所有的钱投给他自己，这是投资者取回投资和收益的唯一途径。它没有像我们上节课说的那种with子座函数。大家还记得上节课那个网上拍卖的例子吗？拍卖结束之后，你如果没有竞拍成功，你可以调用这里面的尾的座函数把钱取回来。The到这个基金里没有实现这个韦德助函数，所以你要想取回钱只能用拆分的方法。

拆分之前，有七天的辩论期，大家可以讨论一下这个拆分好不好之类的，也可以决定要不要加入这个拆分。拆分之后有28天的锁定期，就是成立一这个紫基丁之后，不是要把相应的这个以太币打到这个紫基丁里面吗？然后在里面要28天以后才能取出来。我们后面会看到就是这28天的锁定期给了以太坊社区采用补救措施的时间。

拆分的理念并没有错，就拆分子基金的理念并没有错，而且可以说是民主制度的进一步体现。民主制度并不是绝对的少数服从多数，而是说也要尊重少数人选择的权利。既然这个拆分的理念没有错，那问题出在哪里呢？问题就出在了到底实现什么？我们看一下这部分的代码。

这是spt到的代码，大家注意这个地方。就这个语句，首先把钱还给调用这个函数的人。然后把the到中的总金额减少相应的数量。再把调用者的账户清零。看到这里大家应该已经引起警觉了。我们上节课讲过，正确的操作顺序是先把账户清零，然后再转账。黑客就是利用这个漏洞进行的重录攻击。

我们前面讲过the道是从2016年5月开始众筹的，差不多一个月的时间筹集到了价值1.5亿美元的一台币。然后黑客就利用这个重入攻击，从里面转走了5000万美元的一台币，差不多3分之1。这件事情当时在以太坊社区引起了很大的恐慌。就大家本来认为前途无量的这个热道，去中英化这么美好的一个理念，在现实当中被证明是不堪一击的。这个事件也引起了以太币价格的大跳水。

以太坊社区对此进行了激烈的讨论，就是该怎么办？社区的意见分裂为两派，一派认为要回滚交易，就是我们前面说过，成立的子基金有28天的锁定期，所以黑客暂时还没有办法把钱取走，还有时间可以采取补救措施。那么通过回滚交易，就不能让黑客得逞，这样能够保障广大投资者的正当利益。另一派认为，不需要采取补救措施，因为黑客的行为并没有违法，他犯什么法了吗？既然我们说寇的一字路，大家听说过这个说法吧？我们上节课讲过，规则是由代码来决定的，代码中的漏洞也是规则的一部分。

就这个事情发生之后，网上流传的一封据说是黑客写给以太坊社区的公开信。就公开信里黑客就说我没有做错任何事情，我只是利用了你代码中的一个feature，就spdown那么写，他认为是个feature。既然你代码写的可以让我重复多次取现，我就利用这个飞车来达到了我想要做的目的。并没有违反任何法律。

所以，以太坊社区有一派人是认为不应该采取补救措施的，尤其是不应该回滚交易。因为区块链最重要的特性是什么？是不可篡改性，如果出了问题就回滚，那怎么能叫不可篡改呢？

而且你想想这次出问题的是什么？只是以太坊上运行的一个应用而已，the倒是一个以太坊上的智能合约，以太坊本身的代码没有问题，只是上面的智能合约里有一个安全漏洞。那以太坊有那么多的智能合约对不对？如果每个智能合约出了问题都回滚的话，那不得乱套了吗？那你还说什么叫做不可篡改的、去中性化的账本呢？这是以太坊社区两派不同的观点。以太坊的开发团队就是为他那帮人是支持采取补救措施的。

主要是这个事情的影响太大了。就是的道筹集的这个以太币数目已经占到当时以太币总流通量的很大一部分，大概是10%几，这就已经很大了。一个智能合约能占到10%几就已经很大了。如果我们放纵不管，那么这些以太币当中有大概3分之1要落入到黑客的手里。我们真的希望这么多的以太币都集中在黑客手里吗？而且我们那么多投资者的利益怎么办？就或套用一句美国金融危机当时的说法，the
Dow这个基金叫做to big to fail。

大家听说过这个说法吗？2008年美国金融危机的时候，当时美国有两大房地产公司，番天梅和freday
ma这。两家房地产公司有多大呢？美国有一半的home
mortgage都是由这两家公司提供的担保。当时发生金融危机，好多这个房贷还不了了，两家公司撑不住了，快要破产怎么办呢？最后美国政府出面拯救了这两家公司，原因就是他们太大了，如果垮掉会对美国经济造成严重的打击，所以这叫to
big to fa那么？以太坊社区有些人认为the dog这个基金也是属于to be to
feel，所以还是要救的。

我们今天讲完这个事情，大家不要产生一种错误的安全感，好像以太坊社区会介入干预一些事情。如果就是个小的智能合约出了问题，或者是你自己转账转错了，转到别人的账上，以太坊社区是不管的，开发团队也是不管的。好，假设我们要采取补救措施，怎么补救？比如说我们就从发生攻击的那个区块之前开始分叉，这样行不行？我们可以画一个例子。

比如说。从这个区块开始，黑客进行了盗取以太币的攻击，我们从前一个区块开始分叉。就大家商量好了，上面这条链我们不认了，从下面继续开始挖。

最后让上面这条链，下面这条链比上面这条链还要长。这是我们以前常见的一种分叉攻具的方法，这样行不行？

大家觉得可以吗？

一把黑色的都给抛弃。必许所有人都。

这个问题倒不是所有人要都统一，假设我们有一种方法，所有人统一往下面挖，这样会有什么后果？不光是这个黑客攻击的交易回滚了，上面这条链，后面的所有交易都回滚。大家听明白了吗？这里面有很多是合法的交易。The道只是以太坊上的一个智能合约，还有好多别的智能合约在运行，另外还有一些正常的网上支付，网上转账的交易。本来我转给你钱，以为没事了，结果一回滚，这转账就作废了，那不乱套了，对吧？所以这么干是不行的。大家听明白了吗？

要回滚的话，必须要精确定位，只能是针对黑客盗取以太币的那些交易，其他发生的正常的交易不能够受到影响，这是采取补救措施的一个原则。那怎么操作呢？以太坊团队制定了两步走的方案。第一步首先要锁定黑客的账户。第二步再设法把这个盗取的以太币设法退回去，就清退了到基金上的这些钱。先说第一步怎么锁定这些账户。以太坊团队发布了一个软件升级，在这个升级的软件里增加了一条规则，凡是跟the到这个基金上的账户相关的，不允许做任何交易。大家听明白了吗？这发布之后，大多数以太坊的矿工都升级了这个软件。好，那我来问一下，这个是属于软分叉还是硬分叉？

你说什么这个是软分差，为什么是软分差？

就是我这个神级的朋友，我是就说我的这个。但是如果以前的那个区块，他没有这个泽到的交易。以前的区块就是以前的内部的店，没有升体的狂还是任务。

这个说的是对的，就这个软件升级本质是干一件什么事情？是增加了一条判断的规则。就当一个节点收到一个交易的时候，判断这个交易是不是合法。增加一条新的规则，就是the到相关的账户不准做任何交易。说如果这个交易是跟the到的账户相关的，就认为这个交易是非法的，就等于加一条规则。

增加这个规则之后，新矿工挖出了区块，旧矿工是认可的，因为旧矿工不知道这个新规则，他也不会去查这个。但是旧矿工挖出的虚块，新矿工有可能不认可。如果这个区块里包含了the到账户的交易，新矿工就不认可。所以这是一个软分叉。

大家还记得这个区别吧？就是如果你这个软件升级之后，可能造成区块链的永久性分裂，这叫硬分叉。如果只能造成临时性的分叉，最后还是能合在一起，这叫软分叉。所以这是个软分叉。

这个软件升级的想法是挺好的，也得到了大多数矿工的支持。遗憾的是升级之后的这个软件有一个bug。这个bug不是功能上的bug，也不是安全漏洞。就不是说像那种有宠物攻击风险那种bug，而是跟汽油费相关的。我们说你增加一条规则，收到一个交易，判断一下这个交易是不是跟the道的账户相关的。如果是的话，认定是非法交易，不予执行。这个时候还要不要收取汽油费？你们觉得要不要？

本来这个交易应该是合法的，没有这个新规则是合法的。现在我加入规则之后变成非法了，所以我这个交易是不能正常执行的。汽油费还要不要收它？

可能就是发生攻击，然后一直给你发这个跟。执行一半又回给，然后就给他。前面我们讲机构费是为了防止他无限的随便发交易日是为了防止这个人。但是如果不收汽油费的话，基本上没有成本的税用可以干这。

种事情。就汽油费的机制很大的一方面是为了防范denof service
attack。如果不发收齐邮费的话，可能会有一些恶意的攻击者不断的去发放这种非法交易，浪费矿工的资源，反正对他来说成本很低。以太坊社区发布的这个软件升级，恰恰就是在这种情况下没有收汽油费，就检查地址发生错误的时候没有收取油费。结果网上有大量的这种service维tag，都是这种非法的交易进行冲击。

本来是大多数矿工都已经升级了软件的，但是升级之后就不停的受到这种攻击。过不了多久，这些矿工就已经受不了了，于是飞纷回滚，他的软件升级又改成了原来的版本，于是这个软分叉的方案就失败了。这个时候形势就比较严峻了。我们前面说过，子基金成立之后有28天的锁定期，然后黑客就可以把钱取走了。软分叉的方案失败之后，剩下的时间就不多了，那怎么办呢？既然软的不行，我们就来硬的。

以太坊这个团队设计一个硬分叉的方案。通过软件升级的方法，把得到账户上的所有资金强行转到另外一个新的智能合约上去。这个新的智能合约只有一个功能，就是退钱。你当初不是用以太币买的到的代币吗？现在可以把这个代币退回成以太币，就这一个功能。大家想一想这个为什么是硬分场？

这种做法的本质是什么？用软件升级的方法强行重新记账。本来要转账得有合法的签名。比如说我要把你账上的钱转走，那得经过你的同意，有你的签名才行。这个时候就不管这些了，这是非常时期。凡是the到账户的上面的资金，不管本人同意不同意，都要强行转到一个新的智能合约上去。就有点像是法院的强制执行，大家听明白了吗？

升级的软件里规定了强制执行的具体日期。挖到第192万个区块的时候，就所有升级软件的矿工挖到第192万个区块自动执行这个转账交易，不用什么合法的签名，不合法的签名。这是在升级的软件里写死的一条规则，旧矿工是不会认可这个区块的。因为没有合法签名，你这是非法交易，所以这是个硬分差，大家听明白了吗？

这个硬分差的方案一提出来，在以太坊社区引起的非常激烈的辩论。我们前面不是说过吗？社区本来就分成两派，有一派是认为不应该采取补救措施，这些人认为这种强行重新记账的方法是完全不能接受的。

这不是耍流氓吗？你凭什么把别人账上的钱转走？就以太坊开发团队发布一个软件升级，就能把别人的账上钱转走。那你这叫什么去中心化的那个什么不可篡改的账本，你这跟中心化的组织没有区别，其实比中心化的组织还要差。你法院要强制执行，还得走法律程序，对不对，那被告还能聘请律师为他辩护？你这个就是开发团队发布一个软件升级，把人家钱就给转走了，这哪有这么干的，对不对？支持硬分差和反对硬分差的两派。

争论的非常激烈，那么最后怎么办呢？投票以太坊团队实现了一个用智能合约投票的功能，你可以把手里的以太币发到智能合约里去进行投票。最后投票的结果是大部分人支持应分差，于是绝大多数矿工也升级了这个硬分差的版本，大家就平心静气的等着挖出第192万个区块的历史性石刻。这一次没有出现意外，硬分叉成功了，黑客盗取以太币的行为最终还是没有能够获利。大家听明白了吗？所以听到这里，我们这个故事应该是圆满的结束了。我们这节课好像还剩下十几分钟，我们可以提前下课了。

但等一下其实这个故事没有结束，当初那些反对硬分差的人，并没有因为这个投票结果而改变历程。他们认为首先这次投票参与的人不是很多，因为投票怎么投？它是有两个智能合约。你如果支持应分差，你把以太币发到一个智能合约里，你要是反对应分叉，你发到另外一个智能合约里，然后又锁在这个智能合约里，等投票结束之后再退回来。有很多以太币根本就没有参加投票，这是第一点。

第二点也是更重要一点，投票就能说明问题吗？大多数人的意见一定是对的。像中国现在有很多超级富豪，非常有钱，普通老百姓买不起房子，看不起病。就跟上星期热播的一个电影我不是药神，有的得了绝症了没有钱买药。我们现在中国发起一个投票，把那些首付的钱给平分了，大家觉得好不好？你们觉得投票结果是什么？肯定大多数人都支持，对不对？反正分的又不是我的钱，但是你这样做是不是真的公平？

硬分叉之后，旧的那条链并没有消亡，还是有一些矿工留在上面继续挖。只不过算力是大幅度下降了不到原来的10分之1。但是这样也有一个好处，就是挖矿难度也大幅度下调了。因为竞争没有这么多，没有这么激烈了，所以还是有一些矿工愿意留在旧链上去挖。过一段时间，有一些交易所开始上市，交易旧链上了以太币。

我们说以太币这个符号叫做eth对吧？

硬分叉之后，新的那条链继承了这个符号，还叫一H旧链上继续挖，挖出的以太币叫EC。

经典以太坊？那么在旧练上挖的那些矿工，有一些是出于投机目的。因为旧链上挖矿难度小，容易挖到壁，而且上了交易所之后，盈利就有了途径。但是也有一些矿工在旧链上挖是出于信仰，就这些人坚持纯而又纯的去中心化的理念，认为旧恋才是正宗的，以太坊耕正苗红，那些搞硬分叉的是在搞修正主义。所以也有一帮人是非常坚持在旧练上去玩。

这个etc刚开始上交易所的时候，有很多人认为他的前途有非常大的不确定性。因为以太坊的核心开发团队都是支持硬分叉的，都是转到星链上去开发的。那么旧恋还能存活多久？这是当时大家的一个疑问，结果他一直存活到了现在，就一直到现在以太坊还是新链和旧链两条链并存。

在刚开始硬分叉的时候，两条链并存其实带来了很多问题。因为这两条链的代基本上是一样的，就除了硬分差相关的规则是不一样之外，其他大部分代码都是一样的。而且应分叉之前用的也是同一套历史账本，用的同一套账户私钥都一样。这样会带来一个什么问题？重放攻击在星链上一个合法的交易放到旧链上去同样是合法的，你重放之后也是可以执行的。反过来旧链上的一个合法交易放到新链上也是能执行，就带来很大的一些管理上的混乱。后来给这个两条链增加一个ID。

就把它区分开了，现在就是两条separate的链路。交易所上还是有两种不同的以台币et和etc并存，而且旧链上的算力已经比当初刚刚硬分差的时候提高了很多倍了。到这里，我们这个故事是真正的讲完了，同学们有什么问题吗？

没有问题。我问一个问题，我们前面讲的时候有一个细节，大家注意没有？不论是软分叉的解决方案和硬分叉的解决方案，我们的目标都是为了锁定黑客盗币的那些账户，对吧？但是我们讲解决方案的时候，都是把the到的所有账户作为目标。比如软分叉的时候，the
dog的所有账户都不准交易，硬分叉的时候，the
dog的所有账户都要强行转入新的智能合约。为什么不能只针对黑客的那些账户？

你说回退的时候找不到黑客的账户，不知道哪些账户具体是。

黑客拿了一些钱，这些钱该退给谁可能会比较。

你说因为不知道黑客的钱该退给谁，但是我把他的钱反正没收了，然后按照发生攻击之前，每个账每个人账户上的余额去退。实际上最后也是这么操作的。

智能合约的内容都是公开的，包括智能合约所有的变量存储什么的。就我们上节课讲的成员函数定义成public是其他账户可以调用。但是即使你不定义成public，那个函数本身的内容都是大家可以看得见的。就区块链上的代码都是公开的，都是开源的。

大家能想到更深层次的原因吗？

不是除代码以外的。如果我们只冻结黑客的账户，那么the到的其他账户该怎么处理？

其他账户是好人的，所以不用管他，还正常运行。我们上节课讲过一个很重要一点，如果你的智能合约写的有bug，你发布到商发布到区块链上之后就改不了了。The到这个智能合约是有bug的。这个bug黑客这次用了，下次别人也可以用。大家听明白了吗？你光是把黑客的账户冻结了，剩下的账户继续运行吗？那任何人都可以成为黑客，再用同样的方法偷以太币，这个bug你修不了。所以智能合约出现这种致命的bug就作废了。

事实上最后它也作废了。为什么？它只存活了三个月？硬分叉之后，这个曾经红极一时的投资基金惹道就随之解体了。大家听明白了吗？所有的账户都不安全了，人任何人都可以重新模仿一下黑客的攻击。好，没有问题，这节课就讲到这儿。
