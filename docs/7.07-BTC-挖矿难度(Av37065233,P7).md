**7.07-BTC-挖矿难度(Av37065233,P7)**

今天我们讲一下比特币系统中怎么调整挖孔难度。挖矿就是不断的尝试block
header里的难子值，使整个block loheader的哈希值小于等于给定的目标阈值。

这个他给的就是目标阈值，这个他给的越小，挖矿难度是越大。调整挖矿难度就是调整目标空间在整个输出空间中所占的比例。比特币用的哈希算法是SHA256。Secure.

Ha这个产生的哈希值是256个，所以整个输出空间是。二的256次方，这可能的取值。调整这个比例，目标空间占输出空间的比例，有时候通俗的说就是这个哈希值前面要多少个0。就比如说256位的哈希值，要是合法的区块要求算出来的哈希前面至少有70个0。当这个是一种通俗的说法，不是特别的准确。因为这个目标阈值并不是说前面都是零，从某一个位置开始，后面的都都变成一了，他不是这样。所以严格的话还是要按照这个定义去去看这个问题。

那么。我们听到的另外一种概念就是挖矿难度。这个挖矿难度跟这个目标阈值是成反比的。

这个difficulty
1，它bit是指挖矿难度等于1的时候所对应的目标阈值。挖矿难度是最小就是一，它最小就是一，这个时候对应的目标阈值是个非常大的数，就是我们这个不等式，他给的是越大的时候挖矿是越容易的。因为你这个目标空间占的比例非常大，所以难度为一的时候，它对应的这个目标阈值是很大的一个数。用这个很大的数除以当前的目标阈值，得到的就是当前的挖矿难，就这俩是成反比。

那我们为什么要调整挖矿难度呢？如果不调的话会有什么问题？系统里的总算力越来越强，包括难度保持不变的话，那么这个出画时间是越来越短了。一开始的时候，没有多少人参与这个比特币游的时候，可能你按照设计是十分钟出一个区块。后来参与的人多了，变成一分钟就能出一个区块。然后再到后来，挖矿的人越来越多，用的设备越来越先进，可能只要10秒钟就出一个序号，甚至到最后不到一秒就出一个区块。就出块时间会越来越短。

当然有的人可能觉得这是好事，你出画时间越来越短，说明我要是发布一个交易的话，很快就能被写到区块链里。你提高了系统的响应时间，增加了系统的修复，那这不是好事吗？如果要是好事的话，那实际上我们没必要把这个出块时间设计成十分钟。因为这个十分钟本来也是人为选了一个参数，孵化时间太短会有什么问题吗？

比如说我们不到一秒钟就出一个虚花，这个区块在网络上传播的时间可能需要几十秒，它底层的底特币网络可能要几十秒的时间才能让其他节点都收到。那么别的节点在没有收到这个区块之前，还是继续沿着已有的区块链往向扩展。如果有两个节点差不多同时都收到这个区款了，而且差不多同时都发布了一个区块，那么这个时候会出现分叉。

比如说这个时候两个节点同时挖到跨。这两个区块同时被发布出来，就出现了一个二分产。出罐时间如果是越来越短的话，这种分叉会成为常态。而且就不仅仅是二分叉，可能出现很多的分叉。比如说如果有十个区块差不多同时都被挖出来了，那么这个系统中会出现一个十分差。这个地方我还画不下，十分长。

我们画个大概的。

分叉如果过多的话，对于系统达成共识是没有好处的，而且也危害到系统的安全权。比特币协议是假设大部分算力掌握在诚实的矿工手里，系统当中的总算力越强，安全性就越好。因为你要发动51%攻击，所需要的算力就越大，这个叫做。

51%。

这意思就是说，有个恶意的节点掌握了系统当中51%以上的算率。这时候他就可以干各种各样的坏事，包括我们前面讲过的分叉攻击。比如说在。在这个区块里有一个转账交易。A转给B一大笔比特币转了很多钱。我们这个画的比较短，假设这后面跟着六个确认区块，就跟经过六个确认之后，B认为这个转账交易已经成功了。这个时候A从这个地方开始分叉，要回滚这个交易。把钱转给他自己。

正常情况下，这个攻击的难度是比较大的。如果大部分算力是掌握在诚实的矿工手里，你想让这个链比上面那个链还要长，这个难度是比较大。但是如果出现了很多个分叉，那么这个时候系统里的总算力就会分散。就比如说这个例子当中，我们假设出现十个分叉，那么节点根据在网络中位置的不同，可能会选择沿着其中的某个分叉继续往下扩展。而这个有恶意的节点可以集中算力就扩展他这个分差。

这样很快就可以使这个分叉变成最长合法律。因为好人的算力被分散，这个时候可能你就不需要51%的算力才能发动攻击了，可能10%几的算力就够了。所以这个出块时间不是越短越好。

当然了，出款时间不是越短越好。那么是不是说在比特币协议中设计的这个十分钟的出块间隔就是最优的了？这个不一定。比如说你把它改成八分钟行不行，改成五分钟行不行，应该也都是可以的。这个只是说出画时间要有一个常数的波动范围，不能无限的减少下去。

有些人觉得比特币当中的十分钟的出块金额有点太长了。就对于一个支付系统来说，你做一个支付你要等那么长时间才能得到确认。这个时间有点太长。我们后面会讲到以太坊，以太坊里的出罐时间就降低到了15秒，所以以太坊的出块速度是比特币的40倍。这个初块时间大幅度下降之后，以太坊就要设计一个新的共识协议，叫ghost。

在这个协议当中，这些分叉产生的这个叫所谓叫窝分布，倒我们以前讲过。

这些often
block就不能够简单的丢弃掉，而是也要给他一些奖励，这个叫做安河瑞沃。

关于这个以太法的具体运行情况，我们后面可不会讲。这里我就强调一点，以太坊中同样需要调整挖矿难度，使得出库时间保持稳定。它降到15秒以后，这个15秒也要设法保持稳定。所以平均出款时间到底设计成多长，这个没有一定之规。但是不论设计成多长，都需要保持稳定，而不能无限的减少下去。大家有问题吗？

好，我们讲了怎么去就是为什么我们要调整挖款难度。下面我们讲一下具体怎么调整还款。比特币协议中规定的是每隔2016个区块要重新调一下这个目标阈值，这个大概是多长时间呢？大概是每两个星期调整一下。2016个区块，每个区块是十分钟，1个小时是60分钟，一天是24小时，就这个大概是14天。14天要调整。那具体是怎么调整呢？

看照这个公式。

这是他给的这个目标阈值迭代更新的方法。这里的expected
time就是2016乘以十分钟，就是两个星期。如果是理想状况下每十分钟产生这个区块，那么产生2016个区块就要这么多的时间，就是它预期的时间。这个阿碳是系统中产生最近的2016个区块实际花费的时间，所以这个是。

十几万矿出间。这公式是什么意思呢？就如果这个实际时间超过了两个星期，说明平均下来出块的间隔超过了十分钟。那么这个时候这个挖矿难度是应该调的低一点，对吧？应该让出矿更容易。这个时候我们看这个公式，它是比两个星期大，所以这部分是大于1的。所以乘完之后，它给的会变大，因为这个成反比，你它给的变大之后，挖矿难度就降了。

如果这个实际时间是小于2个星期的，说明这个出画速度有点太快了。那么这时候应该提高挖矿的难力，这个比两个星期小，这个就是个小于1的数，对吧？所以算出来的它底成了会变小，相当于挖矿难度提高。

实际代码当中，上调和下调都是有四倍的限制。就比如说这个实际时间非常长，超过了八个星期就正常应该是两个星期。它超过了八个星期，那么我们算的时候也只按照八个星期来算。就这个地方这个目标阈值增大最多也是增大四倍，不会超过不会一次性超过四倍。这个主要是为了避免系统中出现什么意外情况，导致这个目标阈值有特别大的活动。

相反的，如果这个实际时间非常短，不到半个星期就把这个2100
16个区块都出来了。这个时候我们也按照半个星期来算，就这个地方最小它也是4分之1，相当于这个目标阈值最小是就减小的时候，最多是减小四倍。也不会一次性接下的特别多。这就是调整目标预知的方法。

那怎么才能让所有的矿工同时调整目标阈值呢？因为这个去中心化的系统，你怎么能让大家都那么听话，到处都调。这个计算它里头的方法是写在比特币系统的代码里，每挖到这2016个区块，它会自动进行调整。因为这个代码里头这么写了，到这个时候就得调。当然了，这个代码是开源的。所以如果有某个有恶意的节点，到这个时候他就故意不调会怎么办？大家听明白这问题了吗？

可这个新的，它这块。

就不行。

这个说的基本上是对，就说白了是什么？你如果不调的话，那么你发布的区块城市的矿工不会认他。大家还记得我们讲不到嗨的那节课，我们讲有一个这个寓。这还记得吗？

NB词语这个是我们这个tarit的一个编码的版本，就在block
header里没有直接存储这个tar给的域，因为这个域是256倍，你直接存这个的话要32个字节。这个NB在der里只有四个数据，所以可以认为是它的一个压缩编码。如果遇到有恶意的矿工，该调的时候他就不调。这个时候检查的这个区块合法性就通不过。因为每一个节点要独立验证发布的区块的合法性，那么检查的内容就包括这个NB这个目标阈值设的对不对。如果你投机取巧设一个过大的目标阈值，使得你自己挖矿容易了，但是别人算出来你个设的不对，这个区块是不会被接受的。

大家觉得这个比特币调整难度的方法复杂吗？其实是比较简单的对吧？我们后面讲到以太坊的时候会看到以太坊也是要定期调整把控难度。但他这个定期不是说隔多少个区块，而是每个新出的区块都有可能进行调整，而且调整的方法也比这里讲的要复杂的多。有问题吗？

面包的贯输的这个时思维，你看这各种是经验的预旨，还是说这个预旨是他事先经过论文发表，是经念剧。我觉得就是中本从可能自己拍脑来想，也不叫拍脑来想，就他根据他的就过去有很多。

就是。

有些人觉得没有买比特币特别可惜。因比特币当初那么便宜的时候怎么没有买？就现在回过头去，你可以说比特币是一个多么伟大的发明，它当时有多么革命性。其实如果你了解历史的话，在比特币之前有很多加密货币都是失败的。就是比特币出现之前大概有20年的研究，研究各种各样的加密货币最后都不行。

比特币成功其实并不是因为它更实用。从某种意义上说，是因为它更不实用。就以前失败的那些加密货币都是怎么设计的？是设计成它是限实货币的一个电子支付，就是电子支付渠道网上支付的方法。就你得有一些真的货币，后这些货币线下流通可以，线上不方便。它有一个线上的版本，比特币是没有任何真正法币背书的，它没有底下的保证金，完全是凭空造的这种货利。

那么充本冲设计这些加密货币的时候，里面有很多参数，出管时间设成十分钟是不是最好的？这个有争议，每个块最多一兆字节是不是合适的？还有刚才你说的为什么是2016个区块调一次，要以太坊里，就是每个区块都可以调，对不对？就这些参数，你的问题是是中等聪从哪些论文里得到的一个验证的参数吗？是个经验参数吗？还是怎么来？你是问这个是吗？我觉得可能是他看过一些调研，也经过思考选的这些参数，总的来说还是make有sense，还是比较有比较合理的。

但是不是最优的得有争议。就比特币系统的设计，总的来说是比较保守的。你从出块时间，从区块大小，从它支持的脚本语言来说都是很保守的。就比特币社区一些哈喽货的支持者也是比较保守。他可能是因为自己已经留了很多比特币，他不愿意危及他他自己的财富，所以要改什么东西都是很难的。为什么后面有以太坊，还有各种各样新的这种家约货币，就是这个原因造成的。我不知道这个参数是不是经过很严格的论证，也可能就是他自己怎么想一想还算比较合理。有别的问题吗？

没有问题的话，我们看一下比特币系统中的一些实际情况。

这张图显示了比特币系统中总算力的变化情况。在比特币没有流行起来之前，有很长一段时间算力没有太明显的增长。前面这些年的hash
rate看上去几乎是零贴着X轴，其实这些年算力也是在增长的，只不过是后面这几年算力增长的太快了。所以前面这部分看上去像是一条直线。去年是加密货币涨得非常猛的一年，这也体现在了hash
rate的增长上。这部分曲线是从去年年初到现在，我们可以看到算力呈现出指数级的增长。注意即使是在这段黄金时期，算力也不是单调递增的，中间也是有很多波动，但总的来说是增长的非常快的。

这是挖矿难度的变化情况，跟算力的增长基本上是同步的这也符合难度调整的设计目标，通过调整挖矿难度，使得出块时间保持稳定。注意这个图显示的是挖矿难度，不是目标阈值。这是最近半年的难度调整曲线。可以看出很明显的是一段一段的每隔两个星期难度上一个台阶，说明挖矿的人越来越多，用的设备越来越先进，反映出大家对比特币的热情越来越高。如果出现相反的情况，比如某个加密货币的挖矿难度越调越小。

说明什么？

挖矿变得越来越容易了，但这不是好事，说明大家对这个币的热情是逐渐减少的。如果持续出现这种情况，一般来说这个币就慢慢不行了。这个图显示的是每天的出块时间。从2010年到现在我们可以看到，总的来说出块时间稳定在十分钟上下振动，说明难度调整达到了预期目的。这是最近半年的除化时间，也是按天做了，平均也是维持在十分钟左右。最后这页ppt是咱们这门课用的教科书配套的一页PT上面给出了调整挖矿难度的公式。大家看看他这个公式跟我们课上给出的公式有什么区别。

所以这个地方正好是反过来的对吧？它这个是第开他你在的分子分母式，实际这两个公式都是对的。它这里算的是挖矿难度，我们这里算的是什么？是目标阈值，这个是一个容易引起混淆的地方。大家看到这种公式的时候注意一下，因为这两个是成反比的，看清楚他到底算的是挖矿的难度还是目标依据。实际比特币代码里用的是目标语据。好吧，这部分我们就讲到这里。
