**21.21权益证明(Av37065233,P21)**

这节课我们讲权益证明proof of steake。

比特币和以太坊目前用的都是基于工作量的证明。这种共识机制受到了一个普遍的批评，就是浪费电。我们这个图上显示了比特币能耗随时间变化的情况，这个Y轴是tw
H是。

这是十的12次方。大家平时可能比较熟悉的是KWH。Kinknow what hour?

十的3次方。就所谓的叫千瓦时一度电的意思。这个图上我们可以看出，比特币的能耗随时间是不断增长的。

下面这个图给出了一些具体的统计数据。

比特币每年的总能耗大概是70个7WH泰说word，这相当于治力这个国家的能耗。也相当于647万多个美国家庭的能耗，占全世界总能耗的0.31%。具体到每个交易上来说，平均每个交易的能耗是1014个千瓦时。相当于34.26个美国家庭一天的能耗，这个能耗是相当大的。个大家可以想象一下，一个交易要花1000度电，这听起来都觉得吓人。信用卡公司处理一个交易的能耗远远到不了这个数字。比特币挖矿的每年总收入是六十多亿美元，接近61亿美元。然后费用是差不多35亿美元，占总收入的57.48%，说明挖矿的利润空间还是很大的。

下面这个是以太坊的统计数据。以太坊的能耗也是随时间增长的，中间有一些波动。从具体的数据上来看，以太坊一年的能耗大概是20个tiword
hour，这跟刚才比特币的70个tiword
hour比起来还是少了不少。相当于冰岛这个国家的能耗。也相当于183万个美国家庭的能耗。

这个能耗占全世界总能耗的0.09%。平均到每个交易上每个交易的能耗是67个千瓦时，相当于2.25个美国家庭一天的能耗。这个跟比特币前面1000个千瓦时相比，实际上是少了很多的。

大家有没有觉得比较奇怪？从道理上讲，比特币的交易是比较简单的，就是一些单纯的转账交易。以太坊中的交易有可能包含对智能合约的调用。所以以太坊的能耗应该更高才对，而实际上是比比特币要低了很多。

一个是67度电，一个是1000度电。这个为什么呢？出罐时间长。因为比特币要十分钟才能挖出一个区块，以太坊15秒就可以挖出个虚块，所以以太坊的初画时间很短，它挖矿挖的时间就短，所以它的每个交易平均下来的能耗要小很多。当然以太坊的这个单位交易的能耗仍然比信用卡公司要高了很多，这两个还是不在一个数量级上。

以太坊每年挖矿的收入是五十多亿美元，50亿5500万这么多美元。然后它的费用是接近24亿美元，所以同样的挖矿的利润空间是很大的。如果我们把比特币跟以太坊的能耗加在一起，当做一个国家来算的话，那么他在国家中的排行榜是这样的。是芬兰、比利时、巴基斯坦，然后就是比特币加以太坊，然后是哈萨克斯坦、阿联酋、荷兰，就这样一个顺序。大家有问题吗？

没有问题的话，我们把这个投影仪就关了，我们接下来继续讲。

我们来仔细想一下挖矿这个过程，这些能耗是不是必须的？就大家思考几个问题，矿工为什么要挖矿？你们觉得呢？为了取得出块奖励，为了获得收益，那为什么要给矿工这些收益呢？

为什么要给矿工这些出块奖励？区块链的增长和发展，安全。为了激励矿工参与区块链的维护，就如果不给出块奖励的话，那么矿工没有这种incentive来参与记账。那矿工具体是怎么挖矿的呢？就比如说你决定参与挖矿，就要成为一个矿工，你需要怎么做？

你觉得你会怎么做？你需要找一大笔资金，然后去买这些挖矿设备。这些设备都一起一些现成的设备。你可以买矿机，买制皮U然后开始挖矿。那挖矿的收益是由什么决定的呢？

有挖多少区块决定挖多少区块是由什么决定的？就是由你的算力所占的比例决定的。你的算力是由什么决定的？

你有多少矿机，你占了多少硬件设备，而且设备是由谁决定的呢？是由你投入多少资金决定。因为设备都是标准化的，你投入的资金越多，你买到的设备就越多，你挖矿的算力就越大，你得到的收益也就越高。

所以说白了挖矿的收益是由什么决定？是靠拼钱决定的，看谁的钱多决定的那这就带来一个问题，既然最终是拼钱，那么我们直接把钱拿出来比1比不就行了吗？现在是矿工通过竞争算力来决定这个挖矿的收益如何分配。我们能不能把它改成直接靠笔钱的多少来决定收益分配。比如我出100万，你出50万，现在的做法是咱们用这些钱都去买矿机，然后大家的矿机开始挖矿，比拼一下算力，看谁挖的区块多。与其这样，还不如我们都把这些钱投入到区块链的开发。将来就按照每个人投入的资金的多少来决定收益的分配，那还挖矿干嘛？就直接拼钱不就行了吗？

这个就是权益证明的一个基本思想。有的时候管这种方法叫。What? 虚拟挖矿。

采用权益证明的加易货币，一般在正式发行之前会先预留一部分货币给开发者，也会出售一部分货币来换取开发这个加密货币所需要的资金。将来，按照权力证明的共识机制，每个人是按照持有货币的数量来进行投票的。这种方法跟工作量证明相比有什么优点？

一个很明显的好处就是省去了挖矿的过程，也避免了由此带来的能耗和对环境的影响，减少了温室气体的排放。还有没有什么别的优点？你们还能想到别的优点吗？

基于工作量证明的共识系统。从某种意义上说，维护这个区块链安全的资源不是一个闭环。这是什么意思呢？我们说blockchain
is secured by
manu，那么maning的equipment是从哪来的呢？是用法币买来的，用美元可以购买矿机，然后参与挖矿。也就是说是虫这个加密货币的生态系统外面得到了。

这就带来一个什么问题呢？虽然最近两年加密货币的总市值有了很大的增长，当然了今年开始又下跌了不少。但是不论怎么说，它跟世界经济总量相比仍然是微乎其微的。比如说你跟美国股市的主市值相比，这两个完全不在同一个数量级上。所以如果有某个组织想要发动恶意攻击，他只需要用足够的资金来购买挖矿设备，然后聚集到这个加密货币总算力一半以上的算力就行了。也就是说发动这种攻击所需要的资源是可以从外面的世界得到的。比如说这个组织可能在股票市场上很有钱，在房地产上很有限，在其他的石油金融领域很有限。这些领域的资源都可以转化成挖矿的算力，转换成对这个加密货币攻击的这种能力。

像比特币这样比较主流的加密货币，抗攻击的能力还是相对比较强的。因为它系统的总算力是比较大的。如果是一些刚刚发行不久的小的币种，那么遇到这样的攻击可能就是致命性的。就我们前面讲过autocoin。

我特的提补就是除了比特币之外的一些小的加密货币。如果这种小的币种刚刚发行不久就遇到这种攻击，那么很可能这个币价就直线下降甚至归零了。那么对于这个币的开发者和早期矿工来说，遭受的损失可能是灾难性。这个其实专门有一个词。

叫autocoin infinite
side。大家知道英分的这个词吧？婴儿的意思，英分迪斯就是把他扼杀在摇篮里，不等这个加密货币长大就把它先干掉了。那么如果我们采用的是权益证明，情况会有什么不同呢？

外部的根本没有机会攻击这个区块链，这个也不是绝对。我们想象一下权益证明是怎么工作的。它是有点类似于股份制公司，按每个人占的股份进行投票。权益证明是按照你有多少这个币种的币进行投票。所以如果有某个人想发动恶意攻击，比如说我们前面说的51%的工击，他需要怎么做？他首先要设法获得这个币种发行量的一半以上的份额才行。也就是说发动攻击的资源只能从这个加密货币系统内部得到，这就是为什么我们说它是一个闭环。无论你这个攻击的组织者在外面有多少钱，你有多少美元，你金融界有多少资源，你有多少股票，你有多少房地产，你是石油大亨也好，都不会对这个加密货币系统造成直接的影响。你必须首先要用这些钱去买币，买到足够多的币，然后才能发动攻击。

而一旦有人大量买入这个加密货币会出现什么情况？价格会大涨，对不对？就本来一个刚刚发行不久的小币种，没有多少人买的，价值也不高。突然有人为了搞垮他，大量买入这个币种，结果价格大涨。如果你是这个币的开发者或者是早期投资者，出现这种情况你会怎么想？你会觉得这不一定是坏事儿，我正好可以从中大赚一笔。这有点类似于股份制公司招收恶意收购。

大家听明白这个区别了吗？就为什么我们说工作量证明的区块链系统维护他安全的资源不是一个闭环，权益证明他就是个闭环。权益证明跟工作量证明并不是互斥的。

有的加密货币采用的是一种混合模型，他仍然是要挖矿的。但是挖矿的难度跟你占有的权益，你持有多少币是相关的。比如说每个矿工持有一定数量的这种币，那么挖矿的时候，你持有的币越多，你挖矿的难度就越小。大家听明白了吗？根据你持有的这个币的权益，降低事实的调整你的挖矿难度。当然了，如果你就像我刚才说的这么简单的去设计，其实是有一定问题的。大家想想有什么问题？

那样的话系统中持有币的数量最多的那个人，每次挖矿都是最容易的，对不对？所以有的加密货币要求你投入的币会被锁定一段时间，不能够重复使用。比如挖当前这个区块的时候，你投入一定数量的币用于降低挖矿难度。那么等这个区块发布出来之后，你投入的这些币就会被锁定一段时间。你下次再挖下一个区块的时候，这个币就不能再用了。要过一段时间，过多少个区块以后才能再被重复使用。就这个有时候管它叫做proof
of deposit。

基于权益证明的共识机制该怎么设计有很多挑战。其中早期的这种权益证明遇到的一个挑战就是叫做两边下注的问题，nothing
at stake.

比如说我们有当前这样的一个区块链。

这个地方出现了分叉。

如果是挖矿的话，你会怎么挖？你会沿着上面这条链去挖，对吧？因为这个是最长合法链，其实下面这个链也有可能成为最长合法链。如果这个地方连续挖出好几个区块，它有可能比上面这个链还要长。但是你不会两边都挖，因为这样做对你没好处。你两边都挖的话，算力分散了，你挖到区块的概率就小了。但是如果你用权益证明的话，可以两边都下注。

如果上面这条链成为最长合法链，你在下面这个地方锁定的那些B是没有影响的。就比如说你挖的下面这个区块投入的币只是记录在下面这个分叉上，并不影响你在上面那个分叉的使用。这就是为什么管这个叫做。

Nothing at stake.

这是早期基于权益证明的共识机制遇到的一个问题。

以太坊中准备采用的权益证明协议叫做。

他在过渡阶段也是要跟工作量证明混合使用的，为工作量证明提供叫做finality，就这个finality。

这个反南内题是一种最终的状态，包含在反南内中的交易不会被取消。单纯基于工作量证明，就基于挖矿的交易是有可能被回滚的。就比如说某个交易被写到区块链里了，有人从前面开始分叉，挖出一条更长的分叉链。这个时候你原来写入区块链那个交易有可能就无效了。像比特币当中规定要等六个确认区块，只是说你等了六个确认区块之后，发生回滚的可能性已经非常小了。但是如果有某个有恶意的攻击者，从前面开始分叉，只要他算力足够强，比如说占到了半数以上的算力，那么仍然有可能让这个分叉链变得比原来的链更长。所以单纯基于挖矿的区块链是缺乏这种finality
ity。Casper协议具体是怎么做的呢？它引入一个概念叫做validate验证者。

要想成为一个validata，必须要投入一定数量的以太币作为保证金，这个保证金会被系统里面给锁定住。那么法利date的作用是干嘛呢？职责是要推动这个系统达成共识，投票决定哪条链是最长合法链。投票的权重取决于保证金的数目大小。

这个具体的做法有点类似于数据库里的to face
commit。挖矿的时候就是这个时候，混用的时候还是有人挖矿的。挖矿的时候每挖出100个虚块就作为一个。然后要决定他能不能成为finality，要进行一个投票。大家知道这个two
face commit吧？

这个本科都学过吧。第一轮投票是一个prepare message。

然后第二轮投票是commit message。

Casper中规定了每一轮投票都要得到3分之2以上的验证者才能通过。这是按照保证金的金额大小来算的。实际系统当中不再区分这两个message，而且把这个app呢从原来的100个区块减少到50个区块，就变成了每50个区块就是一个。然后呢每个apple只用一轮投票就行了，这一轮投票对于上一个app来说它是commmessage，对于下一个app来说它是个prepare
message。那么要连续两轮投票，两个app都得到3分之2以上的多数才算有效。

好，我们把这个过程画一下。

比如说这是一条区块链。我们假设从这个地方。到这个地方，这是间隔了100个区块。所以原始版本的这个casp协议是把这个定义成一个。

然后这个app结束有两轮投票，先是有一个prepare
message。然后是一个commit。这两轮投票，每一轮都要有3分之2的验证者才能算通过，这是原始的版本。那么优化以后？

就把这个地方从中间再切一刀。

原来这个100个区块的app分成50个区块的，就这是一个apple。这也是一个apple。

然后每个apple结束的时候只有一轮投票，比如说这个地方有个投票。那么这一轮投票对于前一个艾克来说是commit
message，对于后一个app来说是prepare
message，大家听明白了吗？然后要连续两个app这个投票都要有3分之2的验证者支持才算通过。这就是这两个的区别。

验证者参与这个过程有什么好处呢？如果验证者履行职责的话，可以得到相应的奖励。就像矿工挖矿能得到出块奖励一样，验证者做的这个工作也可以得到奖励。

相反的，如果验证者有不良行为被发现的话，要受到相应的处罚。比如某个验证者行政不作为，该投票的时候他不去投票，结果导致系统迟迟达不成共识，那么这种情况下要扣掉他的一部分保证金。如果某个验证者乱作为就乱投票，给两个有冲突的分岔都投票，就两边下注。这种情况如果发现的话，要没收全部的保证金。那没收的保证金到哪儿去了呢？就是被销毁掉了，就没收完之后就直接销毁了，相当于减少了系统中以太币的总供应量。

每个验证者有一定的任期，就即使你交了保证金，也不是说可以永远当验证者。那么任期满了之后，要经过一定时间的等待期。这个等待期是为了让其他的节点可以检举揭发这个验证者有没有什么不良行为进行惩处。如果等待期过了没有什么问题，那么验证者可以取回当初的保证金和应该得到的奖励，这就又是casp协议的这样一个过程。

大家思考一个问题，我们原来说ca协议可以给挖矿挖出来这个区块链的某种状态做一个检查点，做一个check
point。那这个check
point是不是绝对安全的？换句话说，通过这个验证者投票达成的。有没有可能被推翻？

就我们原来说，包含在反弹中的交易是不会被推翻的，这个是不是绝对的？

假设有某个有恶意的组织要发动攻击，如果这个组织仅仅是矿工的话，那么他是没有办法推翻已经达成的。为什么？因为finality是验证者投票投出来的，单纯是矿工。有恶意的矿工，不论是他算力有多强，如果没有验证者作为同伙是不可能推翻的。

那么什么样的情况下会出现攻击成功的情况？一定是有大量的验证者两边下注给前后两个有冲突的斐纳都下注了。我们前面说过casp协议要求每轮投票有3分之2以上的验证者支持才算通过。所以如果出现这种情况，那么至少有3分之1的验证者是两边都投票了。这个一旦发现的话，这3分之1验证者的保证金将会被没收。大家听明白了吗？

所以我们可以看到，基于权益证明的共识机制和基于工作量证明的共识机制是很不一样的。以太坊的设想是要逐步从工作量证明过渡到权益证明。随着时间的推移，挖矿得到的奖励是越来越少的，权益证明得到的奖励是越来越多的，最后达到完全不用挖矿的境界。

我们今天讲了权益证明的这么多好处，既然权益证明这么好，为什么以太坊不从一开始就用权益证明呢？你们觉得为什么？因为权益证明不是很成熟，工作量证明是比较成熟的，是经过了时间的检验。我们大概两节课前讲过那个bug邦体，大家还记得吗？

比特币和以太坊的挖矿算法都经历了bug帮的检验，没有人发现什么漏洞。很多人认为权益证明是未来的方向，但是目前主流的加密货币用的还是工作量证明，像以太坊一直到现在仍然是在用工作量证明。

上个月有个叫eos的加密货币上线了，大家听说过这个加密货币吗？

这个书称叫柚子。曾经有很多人看好这个加密货币。他用的就是权益证明的思想，完全不用挖矿，但是用的不是casp协议，而是一个叫depo的协议。

先用投票的方法选出21个超级节点，然后再由这些超级节点产生区块。那么这个U呢是六月上旬上线的，现在已经过去了一个多月了，还处于一种调试和完善的过程当中。就总的来说，基于权益证明的共识机制，目前还是处于一个探索状态。大家有什么问题吗？

我最后再说一点，就到目前为止，我们都是假设工作量证明消耗那么多的电是不好的。但是也有人持有不同的观点，就这些人认为首先挖矿消耗的电并不是很多。我们这节课开始的时候看的那个统计数据，比特币的能耗占全世界总能耗的0.31%，以太坊只占0.09%，就这两个加在一起也就占0.4%。并不是很多很多人对工作量证明有反感，是因为觉得做的是无用功，白白浪费了很多电。其实挖矿对环境的影响是有限的。

挖矿的一个好处是提供了把电能转换成钱的一种手段。我们知道电是很难存储的，很多发电站在白天用电高峰的时候，这个电是不够用的。到了半夜又有多余的电，用不完，电也是很难传输的。很多大型数据中心要建在电比较便宜的地方，就是因为传输数据比传输电要容易。像现在很多地方搞清洁能源，建了风力发电站，这些发电站发出带的电除了满足当地需要之外，怎么样才能传回主电网，其实是一个问题。很多国家的主电网设计的时候是单向传输的，就从主电网往边远地区送电是可以的，但是从边远地区把这些清洁能源发出来的电传回主电网就没有那么容易了，需要进行电网改造。

挖矿呢为解决这些问题提供了一个很好的手段，把多余的电能转换成加密货币。像很多比特币的矿场都是建在电力资源丰富的地方，比如一些南方小水电站的旁边，只要是有电有网络的地方就可以挖矿，挖出来的加密货币存储传输都不是问题，只要保管好私钥就行了。所以这些人认为挖矿需要消耗电能并不是坏事儿，可以有效的化解过剩产能，带动当地经济的发展。

大家有问题吗？

好，没有问题，我们这节课就到这儿了。
